#!/usr/bin/env zsh
set -eu -o pipefail

readonly repo_dir="$( cd $(dirname ${(%):-%x})/..; pwd )"

IN_PATH="${HOME}/Code/FreeCAD"
OUT_DIR="${HOME}/tmp/ptar-bench-out/$(date -Is)"
EXTRACT_DIR="${OUT_DIR}/extract"
: ${THREADS:=4}

(
    # build in repo root to pick up rust-toolchain file and .cargo/config.toml file.
    cd "${repo_dir}"
    cargo build --release
)

"${repo_dir}/bin/drop-caches"

mkdir -p "${EXTRACT_DIR}"

echo "Starting archiving with ptar"

time target/release/ptar \
         --in-path "${IN_PATH}" \
         --out-dir "${OUT_DIR}" \
         --threads "${THREADS}"

echo "Finished archiving with ptar"

"${repo_dir}/bin/drop-caches"

echo "Starting extracting"

time ls ${OUT_DIR}/*.tar.zstd \
     | xargs -I% -P${THREADS} \
           zsh -c "time zstdcat % | tar --extract -C \"${EXTRACT_DIR}\""

echo "Finished extracting"

echo -e "\nOUT_DIR=${OUT_DIR}"
